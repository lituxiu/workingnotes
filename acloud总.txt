 aCloud初级培训PPT总结
aCloud初级培训PPT教材下载

     说明：其中“一”代表第1章，“1”代表某章第1个知识点，依此类推。

一、虚拟化基础介绍
1、云计算介绍
（1）云计算基础
  a.计算机怎么处理用户数据？
  输入--计算--输出
  单机计算：
    数据输入输出都在一台计算机上进行。
    只能单用户操作，不能多用户同时操作。
  网络计算：
    C/S架构，客户端通过网络提交数据给服务器，服务器进行计算并输出结果到客户端。
    服务器一般设计为支持多用户同时登录。
  b.计算机处理不过来怎么办？
  加硬件、加计算机
  超级计算机：
    当单台服务器无法满足计算需求时，通过将大量CPU、内存等进行堆叠，并通过专门设计的操作系统进行运算管理，用于大数据处理和复杂计算。
    适用于不可分割处理的数据对象，例如天文演算、基因测序等。
  分布式计算：
    当单台服务器无法满足计算需求时，使用多台服务器并行计算，通过集群、负载均衡等技术，将海量数据进行分割处理，然后对处理结果进行汇总。
  b.双十一之后淘宝空闲的服务器在做什么？
  把服务器资源租出去。
（2）云计算
  a.定义
  一种按计算量、使用量付费的服务模式。
  通过可靠的、便捷的、按需的网络访问入口，进行可配置的计算资源共享池（资源包括计算、网络、存储、应用和服务等），这些资源只需很少的配置交互就能够被快速交付使用。
  b.特点
  超大规模：阿里云、亚马逊等通常拥有数万台服务器节点，分布式部署。
  虚拟化架构：云计算需要按需进行不同的操作系统、部署各类应用，而计算实例运行的位置是对用户不可见的。
  高可用性：通过多副本容错、在线实时迁移等措施来保障服务的可靠性。
  高可展性：云的规模能动态伸缩，满足不同应用的部署规模和需求。
  c.服务形式
  IaaS：基础设备即服务。Infrastructure-as-a-Service。消费者通过Internet可以从完善的计算机基础设备获得服务。例如：云主机、云存储。
  PaaS：平台即服务。Platform-as-a-Service。PaaS实际上是指将软件研发的平台作为一种服务，以SaaS的模式提交给用户。例如：云数据库。
  SaaS：软件即服务。Software-as-a-Service。它是一种通过Internet提供软件的模式，用户无需购买软件，而是向提供商租用基于Internet的软件，来管理企业经营活动。例如：口袋助理。
  d.分类
  公有云：放在Internet上，只要是注册用户、付费用户都可以使用。
  私有云：放在私有环境中，比如企业、政府、机构等在自己的机房中建立，或者是由服务商建设好然后整体出租给某组织的。
  混合云：指企业有自建的私有云，保存敏感数据，确保隐私和安全。同时动态地在公网上申请公有云作为私有云的补充，提供计算和存储服务。混合云通常有专线进行接入。

2、云是怎样实现的
（1）各种技术堆出来的
  云计算关键技术
  a.分布式计算（Distributed Computing）
  b.并行计算（Paraller Computing）
  c.效用计算（Utility Computing）
  d.网络存储（Network Storage Technologies）
  e.虚拟化（Virtualization）
  f.负载均衡（load balance）
  g.高可用性（high availabe）
（2）虚拟化和云计算的关系
  a.虚拟化是云计算中最主要的支撑技术之一。
  b.云计算将各种IT资源以服务的形式通过互联网交付给用户。而虚拟化使IT基础设备的资源部署和分配更灵活。
  c.虚拟化不是云计算中必须的，但他使云计算如虎添翼，能为用户提供更优质的服务。

3、什么是虚拟化
   一种抽象的资源管理技术
（1）虚拟化
  a.将一台物理计算机虚拟为多台逻辑计算机。每台逻辑计算机拥有自己的计算、存储和网络寺基础资源能力，可独立运行不同的操作系统。各个操作系统内的应用程序都可以在相互独立的空间内运行而互不影响。
  b.这样的逻辑计算机称为虚拟机。
（2）Hypervisor
  a.Hypervisor是一种运行在物理计算机和虚拟机操作系统之间的中间软件层，它可允许多个虚拟机操作系统或应用共享同一套基础物理硬件，因此也可以看作是虚拟环境中的“元”操作系统。
  b.它可以协议访问服务器上的所有物理设备和虚拟机，也叫虚拟朵监视器（Virtual Machine Monitor）。
  c.Hypervisor可以直接动作在裸机上，称为“裸金属架构”，其本身作为一个操作系统，使用并管理底层的硬件资源，对上层运行的虚拟机提供资源调用接口。这一类的代表产品有VMware ESX Server、Citrix XenServer和Microsoft Hyper-V，以及Linux下开源的KVM等。
  d.Hypervisor也可以运作在宿主操作系统上，以一个应用程序的方式运行，称为“宿主型架构”。它利用宿主操作系统提供的设备驱动和底层服务来进行虚拟机的内存管理、进程调度和资源管理等。这样虚拟对硬件的访问必须经过宿主操作系统，因而带来了额外的性能开销。典型的代表是VMware Workstation、Microsoft Virtual PC、Oracle Virtual Box等。

4、深信服桌面云方案介绍
（1）桌面虚拟化介绍
  a.采用云计算的思想，将用户的桌面操作系统以服务的形式通过网络进行交付
  b.使用虚拟化的技术路线，以虚拟机承载用户的桌面操作系统，将桌面窗口通过网络提供给终端用户操作使用。
(2)方案
  a.深信服提供一站式、高性价比桌面云方案，通过云桌面技术将办公桌面集中部署在服务器上，使得用户可以使用不同设备随意访问，并且实现桌面维护简单化、业务数据集中化。
  b.整套方案只需要云终端（瘦客户机）、桌面云一体机（包括桌面虚拟化、服务器虚拟化、存储虚拟化等软件平台）两种硬件，即可完成桌面云的快速搭建。
（3）桌面云一体机VDS
  a.一款专为云桌面设计的软硬件一体休服务器，集成了计算虚拟化VMP、存储虚拟化VS、虚拟桌面控制器VDC等软件平台。
  b.用户无需复杂的安装调度过程，将VDS开机之后，只需要按照向导式配置界面执行简单操作步骤，即可完成云桌面快速部署上线，非常方便快速。
  c.用户也可以使用自己的服务器（非一体机），全新VMP系统，然后用相同的方法部署桌面云。
（4）瘦客户机aDesk
  a.云桌面的接入终端，采用低功耗、高效率、无噪音、高度集成的设计，能够长期稳定运行，适用于部署在桌面终端，用于接入访问云桌面。
  b.深信服桌面云同时提供了运行效率更高的ARM架构的终端，以及系统兼容性良好的X86架构的终端。
  c.除了aDesk外，云桌面还支持使用普通PC接入访问，也支持使用IOS、Android等移动终端远程接入访问。
（5）桌面云软件组成
  a.虚拟化管理平台VMP
    充分利用物理主机的硬件资源，为虚拟机提供运行环境，对虚拟机使用的资源进行分配和调度，提供虚拟机管理的操作界面。
    专用于承载Windows XP、Windows 7等虚拟机的运行环境。
  b.虚拟存储VS
    基于网络的分布式存储，通过“存储池化”VMP的所有硬件存储的空间，用于虚拟机的保存、管理和读写等操作。
    以模块化的方式集成在VMP平台中。
  c.虚拟桌面接入管理系统VDC
    对用户和桌面进行访问控制，实现安全、高效的运维管理。
    以虚拟机的形式存在于VMP平台上（软件VDC），也可以在物理设备上工作（硬件VDC）。

5、深信服超融合方案介绍
（1）超融合基础架构
  a.相对于桌面虚拟化而言，服务器虚拟化专门为提供可靠的应用服务而诞生。其具有更高的稳定性、可用性。
  b.超融合基础架构，是一种将计算、网络和存储等资源作为基础设施进行整合，可以根据具体业务系统需求进行选择组合和定义，方便快捷地进行数据中心搭建和业务系统部署的一种技术架构。
（2）超融合方案
  a.服务器虚拟化HCI
   HCI作为服务虚拟化的管理系统，通过将服务器硬件资源进行虚拟化，用于创建若干虚拟机。
   用户可以在这些虚拟机上安装服务器操作系统并部署各种应用系统、挂载虚拟磁盘、调整操作系统设置、调整网络设置等，就像普通的物理服务器一样使用它。
  b.虚拟存储VS/aSAN
   深信服虚拟存储是基于分布式文件系统开发的面对虚拟存储虚拟化趋势的一款产品。当前aSAN集成在虚拟化管理平台HCI上面，通过物理网络整合管理HCI集群内所有服务器的硬件（系统盘除外）。
   aSAN属于超融合解决方案中专为云计算环境而设计、面向一体化市场应用的新一代产品，融合分布式缓存、SSD缓存加速、全局应用交付以及多重数据保护等诸多存储技术，能够满足关键业务的需求，保证客户业务高效稳定运行。
  c.网络虚拟化aNET
   深信服网络虚拟化，通过虚拟交换机、虚拟路由器进行组网，同时还将现有的成熟产品：应用交付AD设备和下一代应用防火墙NGAF等网络设备进行虚拟化，以保证虚拟网络的可靠性和安全性。
   HCI的虚拟网络功能以可视化的网络拓扑方式呈现，所见即所得的虚拟网络操作方式，让网络构建更加简单。
    

二、HCI安装和虚拟机的使用
1、HCI介绍
（1）什么是HCI
  HCI是深信服开发的一套超整合基础架构系统，是一种将计算、网络和存储等资源作为基本组成元素，根据系统需求进行选择和预定义的一种技术架构，具体实现方式上一般是指在同一套单元节点（x86服务器）中带入软件虚拟化技术（包括计算、存储、网络、安全等虚拟化），而每一套单元节点可以通过网络聚合起来，实现模块化的无缝横向扩展（scale-out），构建统一的资源池。
  a.计算虚拟化
   深信服超融合架构解决方案中的计算虚拟化采用HCI虚拟化管理系统，通过将服务器硬件资源虚拟化，用于创建若干虚拟机。用户可以在这些虚拟机上安装操作系统和各种软件，挂载磁盘，调整系统设置等。
   HCI属于虚拟化架构中的VMM，即虚拟化资源监视器，或称为Hypervisor。
  b.存储虚拟化
   深信服虚拟存储（简单aSAN）是基于分布式文件系统开发的面对存储虚拟化趋势的一款产品。当前aSAN集成在虚拟化管理平台HCI上面，通过物理网络整合管理HCI集群内所有服务器的硬件（系统盘除外）。
   aSAN属于超整合解决方案中专门为云计算环境而设计、面向一体化市场应用的新一代产品，整合分布式缓存、SSD缓存加速、全局应用交付以及多重数据保护等诸多存储技术，能够满足关键业务的需求，保证客户业务高效稳定运行。
  c.网络虚拟化
    深信服网络虚拟化，通过虚拟交换机、虚拟路由器进行组网，同时还将现有的成熟产品：应用交付AD设备和下一代应用防火墙NGAF、广域网优化、SSLVPN等网络设备进行虚拟化，以保证虚拟网络的可靠性和安全性。
    HCI的虚拟网络功能以可视化的网络拓扑方式呈现，所见即所得的虚拟网络操作方式，让网络构建更简单。
2、HCI的应用场景
（1）超融合架构可以应用到数据中心涉及的众多业务系统的领域，比如：应用开发测试场景、中小型业务上线场景以及非关键业务系统改造场景都特别适合部署超融合架构。

3、HCI安装
（1）HCI安装条件
   a.服务器配置：64位CPU，支持VT技术；内存大于16G；硬盘大于60G；网卡建议4个及以上。
   b.交换机：千兆/万兆
   c.存储：FC或iSCSI
   d.授权：授权KEY+序列号
   e.IP规划：每台主机一个管理IP，每个集群一个集群IP
   g.HCI安装包
（2）注意事项
   a.BIOS设置中开启Intel VT-x功能
   b.安装前先同步BIOS时间，避免安装后授权失效
   c.BIOS关闭CPU节能模式
   d.不能在VMware等虚拟机中安装HCI，避免虚拟化嵌套
（3）安装步骤
   a.将ISO镜像烧录到U盘/CD
     下载HCI的ISO镜像；使用UltraISO刻录镜像到U盘或光盘，记录后校验。
   b.从U盘/CD启动
     插入U盘或光盘到服务器；开机，修改启动顺序，从U盘或光盘启动。
   c.要按安装向导进行安装和配置

4、HCI管理
（1）默认登录地址：10.250.0.7
  a.浏览器支持：IE10以上；Chrome；Firefox。
  b.登录：https://IP
  c.账号密码：admin/admin
（2）组建集群
  a.组建集群的条件
   两台及两台以上安装相同版本HCI的物理主机；
   每台物理主机至少需要4个物理网口；
   如果需要组建HA虚拟机就必须需要有外置存储或虚拟存储；
   集群中物理主机的管理通信口必须是同一网段，因为集群是通过广播或组播进行通信的。
  b.添加主机
   HCI会自动发现与其同网段的其他HCI主机，并提示加入集群。将其他主机加入本集群时，需要输入其amdin密码。
  c.配置集群IP
   集群IP地址要和管理IP地址是一个网段的
  d.修改集群内主机管理IP
   主机--物理主机--设置主机间通信口--管理通信口。
   最后在“管理--集群配置”中配置管理IP。

5、虚拟机操作
（1）新增虚拟机
  a.上传ISO镜像
   WEB上传：只支持上传*.iso（光盘镜像）、*.qcow2（虚拟机磁盘）、*.ova
   文件共享上传：不限文件格式
   直接挂载共享文件夹：通过网络访问共享文件夹
  b.新增虚拟机
   虚拟机名称唯一、不能重复
   名称可以包括中文、数字、字母及部分符号
   已有磁盘：虚拟机的每个磁盘是以单个文件的形式存放在HCI的存储上，文件后缀为qcow2。
   使用物理磁盘：是将物理磁盘通过裸磁盘映射方式给虚拟机使用
   虚拟机的网卡只能通过物理出口才能连接使用主机的物理网卡，与外界进行通信
   虚拟机网卡类型：Realtek RTL8139、Intel E1000           
  c.安装操作系统
（2）安装性能优化工具
  a.性能优化工具的作用包括
   虚拟机FastIO网卡驱动
   优化磁盘驱动
   上报虚拟机状态信息到控制台
   用于虚拟机管理，包括软关机、热添加CPU及内存、虚拟机报表功能等都需要虚拟机内部安装性能优化工具进行辅助
   工具第一次安装需要用户或管理员手动进行，后续升级则是自动的
  b.Windows系统安装虚拟机性能优化工具
   进入到虚拟机操作系统控制台，点击立即安装
   在虚拟机的桌面中，打开光驱后，自动运行
   弹出安装界面，点击安装即可
   安装完成后，虚拟机会自动进行1-2次重启
  c.Linux系统安装虚拟机性能优化工具
   登录操作系统
   打开终端，cd到光驱目录（若光驱没有自动挂载，需要手动创建/mnt/cdrom目录，在终端执行mount /dev/cdrom /mnt/cdrom命令挂载光驱）
   使用root权限（普通用户使用su root，输入root密码）执行./install sh开始安装
   根据提示完成安装
（3）派生虚拟机
  虚拟机模板通常是一台安装配置完成的虚拟机，用于生成多台完全相同的虚拟机。与克隆不同的是，由虚拟机模板派生虚拟机时，不会对磁盘文件进行复制，派生的虚拟机在使用过程中对原始虚拟机的更新，会以增量保存。
  从模板部署虚拟机时，模板需要是关机状态。
（4）克隆虚拟机
  克隆虚拟机，是将现有的虚拟机完事复制一份，得到一个新的一模一样的的虚拟机。克隆出来的虚拟机跟原有虚拟机不再有任何关联。
  主机或存储资源离线的虚拟机无法克隆
  虚拟机正处于迁移、克隆状态，无法克隆
  正处于备份中的虚拟机执行克隆操作，备份任务会被自动取消
  克隆后的虚拟机系统与原虚拟机除了MAC地址外其余完全一样，请修改其中一台IP，否则会IP冲突
（5）备份虚拟机
  备份虚拟机首次备份时是全备份，后续备份为增量备份。
  建议选择目标备份位置与原位置不相同，这样可避免原位置故障后，无法恢复该虚拟机。
（6）虚拟机快照
  快照是在虚拟机的镜像上做一个标记，当虚拟机系统出现问题时，可以通过快照进行恢复。
  当虚拟机所在的存储发生故障时，是没有办法从快照进行恢复的。

三、虚拟网络
1、网络拓扑
（1）网络虚拟化
  HCI（Hyper-Converged Infrastructrue）也被称为超融合基础架构，是指在同一套单元设备（x86服务器）中不仅仅具有计算、网络、存储和服务器虚拟化等资源和技术，而且还包括缓存加速、重复数据删除、在线数据压缩、备份软件、快照技术等元素，而多节点可以通过网络聚合起来，实现模块化的无缝横向扩展（scale-out），形成统一的资源池。网络虚拟化，或称软件定义网络（Software Defined Network，SDN），是SDDC的一部分。
  HCI的虚拟网络功能以可视化的网络拓扑方式呈现，所见即所得的虚拟网络操作方式，让网络构建更简单。
（2）网络拓扑
  Sangfor HCI使用“所见即所得”的网络拓扑，直观呈现虚拟网络中的虚拟机、网络设备之间的连接关系。使用鼠标简单拖拽，即可快速完成虚拟网络的组建。
  a.节点：
   物理出口：虚拟网络跟物理网络之间，通过物理出口进行连接。
   虚拟交换机：用于虚拟网络内部节点之间的二层连接和转发。
   虚拟路由器：用于虚拟网络内部节点之间的三层路由。
   虚拟网络设备：虚拟网络的安全防护（vAF）和应用交付（vAD）设备等等。添加虚拟网络设备前，需要先导入设备模板。
   虚拟机：虚拟网络最终用于提供服务、产生价值的是虚拟机。虚拟机在“虚拟机”页面中管理，安装操作系统并部署业务，然后可以添加到网络拓扑中。
  b.连线：
   物理网络中，我们使用双绞线、光缆等来连接网络设备和计算机。而在虚拟网络中，我们也需要使用“连线”来连接虚拟的网络设备和虚拟机。
   虚拟网络中，并不是任意两个节点都能直接相连的。虚拟交换机和物理出口不能相连且不能与自己相连；虚拟路由器不能与自己相连；虚拟机只能和物理出口和虚拟交换机相连。
   在编辑模式下，可以在网络拓扑中添加节点间的连线。点击连线图标，然后使用鼠标在需要连线的两个节点图标之间拖拽出一条线。如果这两个节点可以互联，则会弹出网口选择节点用于互联的网口。
   连线上默认会显示当前节点之间传输流量的速率。点击“流量显示”图标可以关闭/开启。
  c.管理
   连通性探测：用于诊断虚拟机节点到目标网络的连通性，选择一个虚拟机作为探测的源，然后输入探测目标IP或域名，点击“开始探测”。探测完成会显示从源到目标经过了哪些节点，或者在哪个节点上丢包。
   提示：连通性探测功能由探测虚拟机执行操作并上报探测结果给HCI控制台，所以要求该虚拟机必须安装优化工具。未安装优化工具的虚拟机无法选择为探测源。   
   
2、物理出口
  （1）什么是物理出口
    物理出口用来连接虚拟网络和物理网络。物理出口对内可以连接虚拟路由器、虚拟网络设备或虚拟机，对外需要连接到主机的物理网络。
  （2）物理出口的配置
   a.如果是多台主机集群部署，对外作为一个整体来提供服务，虚拟机可能在任意一台主机上运行，因此需要每台主机都指定一个网口连接同一个“物理出口”，同时将主机的对应网口连接到同一个二层交换机上，以保证虚拟网络中的流量能从任意一主机发出到达物理网络中。
   “物理出口”对内可以连接虚拟路由器、虚拟网络设备或虚拟机。通过划分“端口组”，将虚拟网络连接到“物理出口”的网口进行分组，通常将具有相同网络属性（如相同的vlan）的网口集合划分到同一个端口组。虚拟网络中的设备或虚拟机可以通过端口组连接到“物理出口”。
   端口组可以指定为Trunk或Access类型。
   b.Trunk用于VLAN汇聚或VLAN中继。Trunk类型端口组收到数据包如果带有VLAN信息，且在指定VLAN范围内，则允许通过，不在指定的VLAN范围内，不允许通过。Trunk类型的端口组通过配置PVID，允许所有不带VLAN信息的数据通过，且在内部转发时默认使用VLAN ID进行封装识别。
   默认端口组以Trunk ALL的方式连接到虚拟网络，允许VLAN范围为1-4094，且允许非VLAN数据转发。
   c.Access用于标记VLAN ID。Access类型端口组收到数据如果不带VLAN信息，则为该数据包打上指定VLAN ID的标记并进行转发，而为该数据包打上指定VLAN ID的标记并进行转发，而在包含该VLAN ID标记的数据包从Access端口组发出去时，会先将VLAN信息去掉。Access类型端口组不会接收所有带VLAN信息的数据包。
  （3）聚合网口配置
  “物理出口”可以直接连接主机的物理网口，也可以连接由多个物理网口组成的聚合网口。单个物理网口的通信带宽有限，使用聚合网口可以将多个物理网口进行绑定，在叠加通信带宽的同时，还提升了网口的冗余容错能力。

3、虚拟网络设备
  （1）概述
    a.将深信服现有的网络设备进行虚拟化
    b.目前支持SSL、AC、WOC、AD、AF的虚拟网络设备
    c.模板管理
      HCI设备未内置vSSL、vAD、vAF、vAC、vWOC，以模板形式单独提供
      模板是将qcow2和配置文件压缩封装，格式为vma
      使用虚拟网络设备前需导入模板

4、虚拟路由器和交换机
  （1）虚拟交换机
   a.虚拟交换机运行在虚拟网络中，连接虚拟机或虚拟网络设置，用于在虚拟网络内部进行数据交换转发。
   将虚拟交换机拖放到网络拓扑中生效后，即可将虚拟机、虚拟网络设备或虚拟路由器连接到虚拟交换机。虚拟交换机内置若干端口，添加连线时选择连接到“内置端口”即可。
   b.编辑虚拟交换机，可以添加或删除连接的虚拟机或虚拟网络设备，被添加的虚拟机或网络设备要求有空闲的网口。
   c.HCI集群中的虚拟交换机是分布式运行的，即一个虚拟交换机在各台主机上均有实例。分布式虚拟交换机可以保证运行在不同主机上、但连接到同一个虚拟交换机的虚拟机之间能相互通信。
   d.详情状态：选择“虚拟交换机”并点击查看“详情状态”，可以通过直观的图形化界面来显示当前“虚拟交换机”连接的虚拟机或设备的详细信息，包括其连接状态、流量排行及网络状态趋势等数据。
   e.广播风暴抑制：当虚拟交换机出现组播或广播风暴的时候，会影响虚拟网络中数据转发，甚至影响HCI主机的正常运行。启用“广播风暴抑制功能”，可以限制发包频率，或者断开某些网口以阻断风暴。
    当虚拟交换机某个端口发包速率超过阈值时，会触发广播风暴抑制。默认触发阈值为40960Kbps，可以配置修改。
    注意：开启“广播风暴抑制”后，可能会导致正常的广播或缓手数据包被丢弃。
  （2）虚拟路由器
  a.路由器是网络中必不可少的组件之一，HCI为虚拟网络提供了虚拟路由器的功能，可解决网络虚拟化后出口路由互联的问题，同时提供包括VLAN子接口、NAT规则、ACl策略、DHCP地址池、DNS代理等完善的功能。
  b.网口：
   路由器作为三层互联设备，用于连接不同的网络。一个路由器的每一个接口都属于不同的网段。
   新建的路由器拥有2个网口，可以连接2个不同的网络。如果需要更多网口，可以点击“添加”并输入需要的网口数量。
  c.路由
   路由器的基本功能是进行路由转发，需要维持一份路由表。网口配置IP后，只存在直连路由。如果要访问其他非直连网络，需要添加静态路由。
  d.地址转换
   源地址转换适用于内网使用私有网段向外网发起访问时，外网没有内网网段的回包路由，需要将内网私有网络转换为外网互联地址进行访问的场景。
  e.地址转换
   目的地址转换DNAT（通常又称为“端口映射”）适用于外网需要访问内网的服务器，但内网服务器使用私有网段，其IP不能在外网访问到的场景。
   路由器使用外网口的互联地址来发布内网私有地址的服务器，外网向该路由器的互联地址发起访问，路由器收到请求后，将目的地址修改为内网服务器的私有地址并进行转发。服务器回包时，路由器将地址转换回去并回复给外网。
  f.访问控制
   路由器具有基于服务端口的访问控制功能，可以对指定IP或网口、指定的服务端口，执行“允许”或“拒绝”的访问控制动作。
   虚拟路由器的访问控制列表是有先后顺序的，所有经过的流量以上往下的顺序进行逐条匹配，如果条件匹配则按指定的动作进行处理，不匹配则继续向下匹配。添加规则后，可以使用“上移”或“下移”操作来调整规则的顺序。
  g.DHCP
   虚拟路由器拥有DHCP功能，可以为指定网口下的PC提供动态IP分配服务。
   配置地址池：虚拟路由器的每一个接口都可以提供若干个DHCP地址池，IP池之间分配的地址不能相互冲突。
   DHCP地址池还可以设置“绑定IP”，即为指定MAC或指定主机名的PC分配固定的IP地址。分配的IP地址必须是DHCP地址池中已配置的IP，MAC地址格式为00-1A-2B-3C-4D-5E或00：1A：2B：3C：4D：5E。
  h.DNS代理
   启用“DNS代理”功能，可以让内部的PC将DNS指定路由器的IP，通过路由器代理解析域名。启用“DNS代理”之前，必须先配置DNS服务器地址。
   启用本功能后，连接到路由器的其他设备可以通过本路由器的DNS代理功能解析域名。
  i.高级
   路由器“高级”配置中，允许启用“高可用（HA)”特性。虚拟路由器不是分布式运行的，其运行位置在指定的主机上。当虚拟路由器启用HA后，会在两个不同主机上建立该路由器的实例，并实时同步会话信息。当路由器当前运行的主机出现故障时，可以实现秒级故障恢复。
   开启HA后，由于会话信息实时同步，会占用少量带宽。
   如果不启用HA，当路由器所在主机故障时，会在其他主机重新创建该路由器的实例并运行起来，缺点是故障恢复时间较长，同时由于会话信息丢失，已建立的连接可能中断。
   系统会根据路由嘎啦连接的网络和主机的性能情况自动选择运行位置，也可以手动指定其运行位置。

5、分布式防火墙
  （1）详情状态
   点击虚拟机网络->防火墙，进入分布式防火墙管理界面。
  （2）特点
   a.操作简单，界面简洁；
   b.不需要安装多余网络插件，即安即用；
   c.提供bypass功能，当防火墙发生故障时，快速放通，不影响业务；
   d.提供排障功能，快速定位网络故障；

四、部署案例
1、准备工作
  （1）需求确认
    a.某公司应用开发部门需要一套测试系统：
     每周至少要测试一套业务系统
     每次搭建测试系统给网络运维部门带来很大的工作量
     每次测试都要改变网络架构和相应的部署环境
    b.根据客户提出的业务系统需求，我们采用超融合架构的方案来做这一套系统。
  （2）网络规划
    a.HCI网段：
     管理通信口网段
     数据通信口（vxlan）网段：独立网段，不和其他冲突即可
     存储私网网段：独立网段，不和其他冲突即可
    b.虚拟机网段
     根据实际业务网络进行规划
  （3）材料准备
   主机（服务器）
   HCI系统镜像（ISO文件）
   U盘/记录光盘
   需要部署的业务系统操作系统镜像（ISO文件）
   普通电脑1台（用户配置）

2、解决方案
  （1）规划
   在数据中心划分了一个独立的区域，用4台超融合一体机，搭建了一套专用的测试环境。利用计算、网络和存储虚拟化模拟出4个测试拓扑模板。
  （2）部署拓扑
  （3）部署方案
   a.管理口eth0连接SW3，确保管理员能管理HCI平台
   b.eth3作为物理出口桥接的物理网口连接SW3
     eth1连接SW1，用作VS存储私网，VS存储私网配置为“无链路聚合”
     eth2口连接SW2，用作vxlan口。
  （4）配置IP地址：
   a.分别配置4台主机的管理通信口eth0口，要配置为同一网段
   b.在其中一台主机上，添加其他三台主机到集群中
   c.配置集群IP地址及管理通信口和vxlan口，管理通信口统一配置为eth0口，将vxlan口统一配置为eth2口，并对eth2口配置IP地址（同一网段）。
   d.将虚拟存储配置为无链路聚合，存储通信网口IP需要配置为同一网段
     双链路聚合优点：将存储数据通信的网络独立出来，能提升虚拟存储的稳定性，冗余机制。
     注意事项：虚拟存储连接的交换机SW1使用普通的二层交换机即可，不需要在交换机上做任何配置。
     将虚拟存储配置为2副本的形式。
  （4）部署业务系统
   a.上传操作系统的ISO镜像
   b.新建Windows虚拟机
   c.安装虚拟机操作系统和必备软件
   d.安装性能优化工具
   （5）虚拟网络配置
   a.新建物理出口
   b.将虚拟机连接到物理出口上
至此超融合已经部署完毕了，可以在超融合平台上部署生意人业务系统了。

五、系统维护
1、授权说明
  （1）深信服服务器虚拟化授权分为三个版本：试用版、标准版和企业版。其中试用版和标准版是免费的，企业版是收费的。
  （2）试用版
  虚拟机数量：无限制。
  虚拟机内存：4G。
  虚拟机核数：4核。
  集群主机数：1主机。
  集群CPU颗数：无限制。
  SDN：Virtual Edge：无限制；Switch：0；Router：0。
  期限：无期限。
  虚拟存储：无。
  VMP过期处理：无过期。
  序列号申请：
  （3）标准版
  虚拟机数量：无限制。
  虚拟机内存：最大8G。
  虚拟机核数：最大4核（核数受物理机限制）
  虚拟机主机数：3主机。
  集群CPU颗数：96颗。
  SDN：Virtual Edge：无限制；Switch：2；Router：1。
  期限：无期限。
  虚拟存储：无。
  VMP过期处理：无过期。
  序列号申请：需要序列号。
  （4）企业版
  虚拟机数量：序列号限制，最大65535台。
  虚拟机内存：序列号限制，最大255G。
  虚拟机核数：无限制（核数受物理机限制）。
  集群主机数：无限制，CPU颗数限制。
  集群CPU颗数：序列号限制，最大1023颗。
  SDN：Virtual Edge：无限制；Switch：无限制，序列号控制；Router：无限制，序列号控制。
  期限：序列号限制。
  虚拟存储：需要vs序列号。
  VMP过期处理：降级成标准版。
  序列号申请：根据Key ID开通序列号。
  （4）企业版授权采用USB Key的方式进行授权，发出来的USB Key是烧好的，插入到HCI主机上就可以使用了。授权Key烧入的序列号分为五部分：
    a.虚拟化平台授权序列号
    b.虚拟存储序列号
    c.上网行为管理序列号
    d.下一代防火墙序列号
    e.应用交付序列号
    f.SSL VPN序列号
    g.广域网优化序列号
  （5）注意
  拔掉USB Key30天内HCI还可以正常使用，超过30天就会变为未授权的，因此在USB Key坏掉后要忙返修。
  一个USB Key最多可以插入到3个集群。


2、版本升级
  （1）升级途径
  深信服HCI升级是从官网下载升级包，通过手动加载升级包升级的模式。
  （2）升级原则
  深信服HCI升级是集群主机同时升级的模式，升级时只需要在主控上的管理界面加载升级包，集群中所有主机都会同时升级。升级后点击重启，集群中所有主机重启完成后，升级就完成了。
  （3）升级步骤
  提示：开启维护模式后，控制台/外部API不再执行任何操作，但是运行的虚拟机不受影响。


                                           aCloud高级培训PPT总结
aCloud高级培训PPT下载

     说明：其中“一”代表第1章，“1”代表某章第1个知识点，依此类推。
  
一、HCI集群
1、集群功能原理
  （1）集群介绍
   集群（HA）是将多个主机（服务器）通过网络连接的方式组成一个整体，各个主机间独立但是又一起协同运行。
   集群虚拟机（HA虚拟机）是运行在集群环境上并且被设置为HA虚拟机的虚拟机。集群虚拟机可以运行在每一个主机上，当某个主机出现问题或者网络中断等异常情况下，集群虚拟机可以 从当前异常主机上切换到其他环境良好的主机上运行，可以有效防止异常情况下业务长时间中断情况。
  （2）集群功能原理
   集群的原理实际上基于共享存储。物理主机通过集群通信口维持集群通信，更新主机状态。虚拟机运行在物理机上，虚拟机连接到虚拟交换机上，虚拟机通过虚拟交换机桥接到物理机的物理网口上连接外网。
   启动集群虚拟机时会做一些检测，过滤出不满足虚拟机要求的主机。过滤的条件主要包括存储、内存和网络。
   过滤后会从剩余的主机中随机选择一个主机来运行这个集群虚拟机。
  （3）HCI集群的4种网络层面：
   a.集群管理通信网口。主机间信息同步，集群管理，虚拟机操作。
   b.存储通信网络。HCI访问共享存储/虚拟存储出口。
   c.数据通信网络。vxlan通信网络，虚拟网络内部跨主机通信。
   d.物理出口。虚拟网络跟物理网络之间的桥梁。
  （4）HA功能原理
   如果其中一个网络中断或者虚拟机正在运行的主机宕机，那么都会将这个虚拟机在这台主机上关机，然后选择合适的主机重新启动这个虚拟机。
  （5）集群配置
   a.添加主机
    每一台HCI主机都是以集群的形式存在，如需将多台主机组成集群，则需选择一台主机作为集群控制器，然后将其他主机添加进来。
    集群要求所有主机的管理IP都在同网段，相互之间需要能进行组播/广播通信。
   b.配置集群IP
    集群IP地址用于集中管理所有HCI主机。
    当集群控制器故障后，使用集群IP可以避免出现无法管理集群其他主机的情况。
   c.修改集群通信IP
    加入集群的主机，如需修改IP，必须在集群控制器上进行批量修改。
    单独修改某台主机的IP，如果修改后无法通信，会导致集群异常。
   d.配置数据通信口（VXLAN）
    虚拟机之间在跨主机进行通信时，需要经过数据通信网口，要求主机之间使用独立的网口进行数据通信。
    虚拟机数据跨主机通信时，会经过VXLAN封装，增加包头导致数据包长度变大。在物理网络中传输时可能导致分片。因此建议开启高性模式，改大MTU，此时物理网络中的交换机必须启用巨帧（JUMBO FRAME）。
   
2、HA运行位置和存储位置
  （1）存储位置
   存储位置是指虚拟机的配置conf文件和虚拟磁盘qcow2文件的存放位置。
   注意：添加存储到HCI集群时，需要对该存储单元重新格式化。请确保该存储单元没有重要数据，且不再用于其他用途，避免数据丢失。
  （2）本地存储
   本地存储是指HCI主机上自带的物理磁盘。安装HCI时，系统保留大约60G空间，剩余空间可用于安装虚拟机，属于本地存储。如果主机上还有其他磁盘，需要从控制台添加为本地存储并初始化。
   本地存储仅允许磁盘所在的主机读写，其他主机无法访问。当该主机故障时，其他主机无法读写其存储的虚拟机磁盘镜像，所以相关的虚拟机无法继续使用。
  （3）外置存储（参考存储介绍PPT）
   iSCSI存储
   FC存储
  （4）虚拟存储
   深信服虚拟存储是基于分布式文件系统开发的一款应对存储虚拟化发展趋势而产生的新产品。当前虚拟存储VS模块集成在虚拟化管理平台（HCI）上，通过网络集中管理HCI集群内所有服务器的硬盘（系统盘除外）。
  （5）运行位置
   运行位置是指定虚拟机运行时使用哪个主机的CPU和内存资源。
   指定主机：
    a.虚拟机的运行位置选择为“指定主机”，则该虚拟机启动时，会在该主机上分配CPU和内存资源。
    b.如果虚拟机的存储位置是本地存储，则只有该存储所在的主机能读写其磁盘文件，也就意味着该虚拟机只能运行在该主机上。
   自动选择：
    a.虚拟机的运行位置选择为“自动选择”，则该虚拟机启动时，会根据CPU和内存使用情况来计算集群中所有主机的负载情况，选择负载最低的主机上分配CPU和内存资源。
    b.iSCSI存储、FC和虚拟存储，都属于虚拟存储，即所有HCI主机都可以同时该问该存储上的虚拟机文件。所以在使用共享存储时，可以指定虚拟机的运行位置为“自动选择”，实现主机资源的均衡分配。

3、HA场景
  （1）外置存储（需要配合图来看）
   存储非aSAN场景
   a.存储网络中断
   上面四种情况，不管其他网络如何，只要存储网络发生中断，必然引起虚拟机HA。
   只断数据出口，虚拟机会先找到出口正常的主机然后在目标主机重新开机（虚拟机在原主机先关机）。
   管理网络和数据出口同时中断，虚拟机在发生异常的主机主动关机，然后在其他主机重新开机。
   仅管理网络中断，虚拟机会执行HA，但无法启动（原虚拟机不会关机）
　 （虚拟机镜像文件会有存储锁，虚拟机运行时会锁住，保证不被其他节点打开，因此管理网络中断的情况，会出现正常的节点去开离线节点上的虚拟机，可能开不起来）
  （2）虚拟存储
   a.仅存储私网断开。
    虚拟机仍可正常访问存储，不需要HA（运行位置有副本，如左边和右边的主机）
    虚拟机无法访问存储，需要HA（运行位置无副本，如中间位置的主要）
   b.存储私网，管理网络同时断开
    虚拟机运行主机有副本，仍可正常访问，但主机离线，其他节点仍可拉起虚拟机（脑裂，出现两个KVM虚拟机进程，存储私网恢复后VS会杀掉一个）
    虚拟机运行主机无副本，无法正常访问存储，主机离线，其他节点正常来启动虚拟机。
   c.仅管理网络中断
    虚拟机会执行HA，但无法启动（原虚拟机不会关机）
    虚拟机会执行HA，但无法启动（原虚拟机不会关机）。

二、存储分类和虚拟存储介绍
1、存储分类介绍
  （1）存储评估参数
   a.容量：存储数据可用的空间大小
   b.读写速度：数据读取、写入的速率
   c.IOPS/IO Depth
    IOPS，每秒进行读写操作的次数，称量存储的随机访问性能。
    IO Depth，IO队列长度，即同时提交给磁盘执行读写操作的指令队列长度，能够衡量存储的吞吐量和整体响应时间。
    磁盘的IOPS取决于队列长度/平均IO响应时间。
   d.寿命：存储磁盘的生命周期，数据的安全期。
   e.成本：性价比等因素。

  （2）本地存储（Local Storage）
   a.计算机内部安装的存储介质；只有当前计算机操作系统能够读写，其他主机只能通过当前操作系统上面开放共享后通过网络访问。
   b.按存储介质分类
    机械硬盘（HDD，Hard Disk Drive）。通过电磁的正负极性来存储由0和1表示的数据。机械硬盘主要由圆形磁碟、高速马达、可移动磁头组成，数据存储在磁碟的扇区里。
    固态硬盘（SSD，Solid States Drives）。一般采用Flash作为存储介质，DRAM作为缓存，通过主控芯片进行读写。
    SSD主流容量：128/256/512GB；HDD主流容量：1/2/4TB
    SSD读写速度：约550MB/S；HDD读写速度：约130MB/S
    SSD尺寸：2.5英寸；HDD尺寸：2.5/3.5英寸
    SSD优点：轻便、搞震防摔、低功耗、无噪音；HDD优点：容量大、使用周期长、性价比高
    SSD缺点：寿命短、售价高；HDD缺点：不经摔、噪音高。
   e.按接口分类
    SATA（Serial ATA），常用于普通机械硬盘、固态硬盘接口；理论传输速度6Gbps（SATA-III）。
    SAS（Serial Attached SCSI），常用于企业级机械硬盘；向下兼容SATA接口；理论传输速度6Gbps-12Gbps。
    PCI-Express：常用于高速固态硬盘阿克卡环部存储扩展。

  （3）外置存储（External Storage）
   a.拥有若干存储资源的硬件设备，运行专用的存储管理系统，对外提供数据存储服务。
   b.通用存储系统
    FreeNAS、Microsoft Storage Server
   c.专业存储
    华为Ocean Storage、惠普HP 3PAR、IBM XIV等
   d.按访问方式分类
    DAS（Direct Attached Storage）直接连接存储。将存储设备通过SAS/SCSI等接口直接连接到一台计算机上，点对点传输。
    NAS（Network Attached Storage）网络连接存储。将存储设备通过标准的网络拓扑结构（例如以太网）连接到多个计算机上，使用iSCSI等协议一对多传输。
    SAN（Storage Area Network）存储区域网络。使用光纤通道（Fiber Channel）和FC交换机进行组网，连接存储阵列和计算机，建立专用于数据存储的区域网络。
   e.iSCSI协议
    SCSI（Small Computer System Interface）是一个通用接口标准，用于计算机和外部设备（硬盘、光驱、打印机、扫描仪等）之间的系统级接口标准。
    iSCSI协议将硬件设备调用的SCSI指令集进行封装并在IP网络上进行传输，实现基于网络的存储数据交换。
　　存储设备与客户机之间使用iSCSI协议建立连接，通过以太网协议来发送SCSI命令、响应和存储数据，形成SAN存储区域网络，即基于高速网络实现的数据块级别的数据存储。
   f.iSCSI关键字
    Target：存储设备使用iSCSI协议提供的存储资源。
    Initiator：发起iSCSI连接访问存储资源的客户端。
    LUN（Logical Unit Number）：iSCSI存储设备可以划分出若干个逻辑存储单元，可以使用LUN来标识，也可以使用target ID来标识。
    IQN（iSCSI Qualified Name）：initiator和target是通过名字进行识别的，每一个iSCSI节点（即initiator）必须拥有一个唯一的iSCSI名称，通常使用IQN来唯一标识initiator。
    iSCSI客户端：Windows系统自带iSCSI Initiator客户端程序。
    g.FC存储
     FC（Fiber Channel，光纤通道）协议是SAN（Storage Area Networks，存储区域网络）中使用的一种数据传输协议。
     FC SAN采用高速的光纤通道作为传输载体，认SCSI-3协议作为存储访问协议，将存储系统网络化，形成高速共享存储。
     WWN（World Wide Name，全球名字），FC SAN网络中，服务器和磁盘设备都统称为Node（节点），每个节点使用一个64位的地址来唯一标识，称为WWN（World Wide Name，全球名字）。FC的上层的SCSI协议通过WWN识别节点并相互通信。
     访问控制：为了保证FC存储服务的安全性，通常会将物理上连通的FC SAN网络划分为多个VSAN，实现不同服务器之间的隔离访问；同时一个VSAN内的磁盘资源，又可以进一步划分为多个Zone，分别指派给不同的Port，达到访问控制的目的。
     HBA卡（Host Bus Adapter），HBA卡是一种专门用于FC存储通信的网卡，通常拥有光纤接口（SFP或GBIC）。每个HBA是一个FC交换对象，拥有一系列特殊的属性，包括HBA ID、Node WWN、Port WWN等参数信息；服务器如果需要连接到FC-SAN使用存储资源，需要配置至少一块FC HBA卡。HBA卡通常插在服务器的PCI或PCI-E插槽上，然后通过光纤连接到FC存储或FC交换机。
     FC存储组网方式：直连组网，存储设备通过FC线路直接连接主机（点对点）；交换组网，存储设备和主机都通过FC线路连接到FC交换机，通过FC交换机进行通信（多对多）。
     FC多路径（Mutli-Path）：通过在存储设备和主机之间建立多条传输路径的方式，避免单条线路故障造成存储不可用。当一条路径发生故障后，主机I/O通信可以使用另一条路径。

2、虚拟存储介绍
  （1）存储
   a.本地存储
    通过RAID增加冗余以提升数据可靠性
    主机之间磁盘不共享，无法跨主机访问
    IO和容量瓶颈，无法平滑扩容
   b.外置存储
    需要第三方存储设备，成本非常高
    存储部署复杂，维护困难
    存在兼容性问题
  （2）分布式存储
   a.分布式文件系统（Distributed File System）是指将同一网络中的不同计算机管理的物理存储资源（本地存储）通过网络组织起来，形成一个统一的共享文件系统。
   b.分布式文件系统的设计基于C/S架构模式。客户端在访问文件时不需要知道它们的实际物理存储位置，即分布在多个计算机上的文件在用户面前就像使用本地存储一样。
   c.特性
    透明性：物理存储位置和底层操作过程对用户透明
    开放性：提供标准访问接口，可操作，可移植
    可扩展性：基于分布式设计，可平滑扩容
    可用性：有数据冗余保障
    一致性：防止通信故障导致存储系统脑裂
   d.开源代表
    Google File System：Google为了存储海量搜索数据而设计的专用文件系统。
    Hadoop Distributed File System：由Apache支持的开源分布式文件系统，具有高度容错性，提供高吞吐量的数据访问，适合大规模数据集上的应用，用于支持分布式计算。
    GlusterFS：应用在集群系统中，具有很好的可扩展性。模块化设计，易于扩展和配置。
  （3）存储虚拟化（Storage Virtualization）
   a.对硬件存储资源进行抽象化实现，屏蔽底层硬件的复杂性，对上怪应用提供标准的存储访问接口。
   b.虚拟化的存储资源就像是一个巨大的“存储池”，用户不会看到具体的磁盘，也不必关心自己的数据经过哪一条路径通往哪一个具体的存储设备。
  （4）深信服虚拟存储
   a.基于GlusterFS分布式文件系统开发的面对存储虚拟化趋势的一款产品。
   b.模块化集成在虚拟化管理平台（桌面虚拟化VMP，服务器虚拟化aSV）上，通过网络整合管理VMP/aSV集群内所有服务器的硬件（系统盘除外）。
   c.将多台主机的物理硬盘组成存储池，统一调度分配。
   d.以VMP/aSV集群为依托，基于分布式存储架构，可进行横向扩展。
   e.存储通信网络：
    虚拟存储是基于网络的分布式存储，需要将所有主机通过IP网络（二层、组播）进行连接，组建存储通信网络。
    基本要求：通信稳定，延时不超过5ms，无丢包；带宽足够，千兆或万兆局域网连接。
    复用管理口：使用VMP/aSV管理口（默认Eth0）进行存储通信。优点：部署简单，无需额外使用物理网口；缺点：业务数据和存储数据之间容易出现带宽抢占。注意：有多余网口的情况下，不能复用管理口。
    无链路聚合：每台主机使用一个单独的网口互联，组建存储私网。优点：业务数据和存储数据隔离；缺点：存储私网没有冗余，链路故障时会导致存储不可用。注意：两台主机部署时，可以用网线将存储通信网口直连起来；超过2台主机，需要用千兆交换机互联，如果跟其他网络使用同一个交换机，务必使用VLAN进行隔离。
    单交换机链路聚合：每台主机使用两个单独的网口组建存储私网；存储通信网口全部接入到同一个二层交换机（千兆以上）；VMP/aSV主机间自动进行聚合，无需在交换机上配置聚合；优点：双倍带宽，且具有链路冗余；缺点：存在交换机单点故障风险。
    双交接机链路聚合：每台主机使用两个单独的网口组建存储私网；存储通信网口分别接入到两个二层交换机（千兆以上）；VMP/aSV主机间自动进行聚合，无需在交换机上配置聚合；优点：双倍带宽，且链路和交换机都有冗余；注意：两台主机两个网口直连属于双交换机链路聚合。
  （5）副本
    a.VMP/aSV平台上的虚拟机以qcow2文件的形式存储，文件在物理磁盘上保存的份数，称为“副本”。
    b.虚拟存储支持2-3副本。
     通过多副本技术，增加数据冗余，避免磁盘或主机故障导致数据不可用。
     副本数量、副本保存的位置对虚拟存储上层的应用不可见。
     副本数在虚拟存储初始化完成后，使用过程中不能再修改。
    c.分布卷
     虚拟存储对上层应用可见的逻辑卷，VMP/aSV读写文件是对分布卷进行操作的，由分布卷组成分布式存储。
     数据写入时先进行分布，分散到各个主机。
    d.复制卷
     复制卷将文件写入具体磁盘，通过副本间的同步复制实现数据冗余。
     每个复制卷包含的物理磁盘个数跟副本数量相同，一个复制卷下每个物理磁盘的数据内容完全一致。
     复制卷的最小组成单位是物理磁盘，即同一文件的不同副本只能保存在不同的物理磁盘上。
    e.2副本
     类似RAID 0+1的实现方式
     优点：可承受单个磁盘故障，或多主机时单台主机离线。
     多主机2副本时，同一复制卷下的2个磁盘自动选择不同主机进行分布。
    f.3副本
     要求至少3台主机，冗余度最高。
     缺点：可用存储空间仅为总磁盘容量的1/3。
    g.写入qcow2文件时，同时写入每一个副本，正常情况下副本数据会始终保持一致。读取qcow2文件时，采用就近原则，优先从当前主机读取副本，当前主机不存在副本，则跨主机时通过存储私网读取。
   （6）磁盘分类
    a.缓存盘
     借助SSD的高速读写优势，提升存储整体IO水平。
    b.数据盘
     虚拟存储底层数据的硬件载体，一般采用大容量、高可靠性的企业级机械硬盘。
     数据盘数量是副本数量的整数倍。
    e.热备盘
     作为备用的数据盘，当数据盘出现故障时，自动替代故障磁盘使用。
    f.读缓存场景：
     一个虚拟机频繁读取相同的数据。
     派生虚拟机共用同一个模板，基于同一个qcow2文件，不同虚拟机读取相同的数据块的概率很大。
     刚写入磁盘的数据，未来被读取的概率较大。
     注意：缓存的最小单位是数据块（Block）。
    g.写缓存场景
     存储通信网络带宽瓶颈，复制卷通过网络写入每个副本，会受到带宽限制，写入操作频繁时，复制卷无法实时写入每个硬盘。
    h.缓存盘工作流程
     上层写入数据请求到达SSD写缓存模块；
     SSD写缓存模块把数据写到SSD磁盘，并获得返回值；
     SSD写缓存模块在确定数据写入SSD磁盘后，即立即返回上层模块写入成功；
     SSD写缓存模块在缓存数据累计到一定量后，从SSD磁盘读出数据；
     SSD写缓存把从SSD磁盘读出的数据批量回写到机械硬盘。

3、虚拟存储维护
  （1）故障处理
    a.磁盘故障处理
    b.主机故障处理
    c.主机、磁盘离线重建
  （2）存储扩容
    a.磁盘扩容
    b.主机扩容
    c.扩容后数据平衡
  （3）磁盘故障处理
    a.替换磁盘
     当虚拟存储磁盘被误拔出后，会显示磁盘离线，此时立即插回，数据可以自动恢复。
     当磁盘故障、不要用时，会显示磁盘故障，需要在集群内插入容量相同（或更大）的新磁盘，然后进行磁盘替换操作。
    b.替换过程
     磁盘发生离线或故障；使用新磁盘进行替换；副本自动重建修复。
    c.界面操作
     可以拔出故障磁盘并在原磁盘位置插入新磁盘，或者在其他盘位插入新磁盘。
     插入新磁盘后，点击“更换磁盘”，然后根据向导提示，对新磁盘进行初始化。
     替换完成后，副本会需要一段时间来自动重建。
    d.热备盘
     如果虚拟存储初始化时有预留“热备盘”，则当存储中有数据盘发生故障时，会自动使用“热血盘”来替换故障磁盘。
     自动替换后，原故障磁盘仍然显示离线状态，需插入新磁盘按向导进行替换，替换完成后的新磁盘作为“热备盘”使用。
     替换过程：磁盘发生离线或故障；副本自动在热备盘上重建；替换故障磁盘自动成为热备盘。
  （4）主机故障处理
   a.替换主机
    集群内有主机离线或故障时，可以使用新的主机替换故障主机。
    新主机的版本必须和故障主机保持一致。硬件配置不可低于故障主机，包括CPU、内存、磁盘个数、磁盘容量、网口个数等。
    更换主机时新主机的IP不要和原主机相同。
  （5）数据重建
   a.当磁盘离线或主机故障，在指定时间范围内无法及时恢复，如果两次发生其他故障，则可能导致数据丢失。
   b.数据重建是在2副本以上场景，复制卷的其中1个副本离线，不能及时恢复时，自动占用其他复制卷的可用空间，进行副本重建并同步。
   c.注意：重建会占用其他复制卷的磁盘，可能导致磁盘可用容量降低。同时重建过程会影响虚拟存储性能。
   d.数据重建过程
    磁盘发生离线或故障；超过指定时间没有替换；副本自动选择空余磁盘重建修复。
  （6）磁盘扩容
   a.当主机上空间磁盘插入新磁盘时，可以将其加入虚拟存储，进行磁盘扩容。
   b.扩容的磁盘数量必须是副本数的整数倍。
   c.如果是多台主机做集群，应把扩容新增的磁盘平均分配到各台主机。
  （7）主机扩容
   a.当主机性能不足，或没有空余盘位来扩充存储时，可以增加主机进行扩容。
   b.主机扩容时，先将新主机加入当前集群，同时将新主机上的磁盘加入虚拟存储，进行初始化。
   c.扩容过程
    新增主机加入集群，磁盘加入虚拟存储。
    现有复制卷的副本会部分迁移到新磁盘。
    新的复制卷会分布到不同主机上产生。
    如果有剩余的磁盘，可以作为热备盘。
   d.如果一次性新增副本倍数台主机，则直接在新主机上产生新的复制卷。
  （8）数据平衡计划
   a.扩容之后，数据依然存在原磁盘上，数据读写的压力都集中在原磁盘上，新磁盘无法及时充分利用，导致资源浪费。
   b.通过数据平衡，可以将原磁盘上的部分数据迁移到新磁盘上（从原复制卷迁移到新复制卷），达到充分利用磁盘和主机资源的目的。
   c.只能对未在使用的文件进行平衡，正在使用的文件不会被平衡，如虚拟机已开机，其虚拟磁盘文件是不会被平衡的。
   d.数据平衡会消耗磁盘IO性能。
   e.假如数据盘1的使用率达到80%，新增主机后数据盘4是新的0%，则平衡后会将盘1的部分未使用的数据迁移到盘4（以文件为单位）。如果数据盘X整体迁移到新主机，称为磁盘替换（以磁盘为单位），以保证副本均衡。

4、存储硬件配置
  （1）概述
   a.深信服桌面云/超融合一体机的主机和硬盘均经过签名处理，不占用虚拟存储授权。
   b.一体机增加硬盘必须使用经过签名的硬盘，不能使用自购的普通硬盘磁盘。
   c.一体机已经预装了VMP/aSV的系统，其经过签名处理，禁止重装系统。如果重装系统，会导致签名丢失，需按普通服务器计算授权。
   d.一体机禁止自行拆机，禁止自行变更硬件配置，否则不予保修。如需增加内存或更换CPU，需走硬件定制流程。
  （2）关于RAID卡
   a.主机硬盘接口足够的情况下，可以无需RAID卡。
   b.如果有RAID卡，建议配置为JBOD（直通）模式，使得虚拟存储能直接感知访问RAID下的硬盘。JBOD模式下支持硬盘热插拔。
   c.如果RAID卡不支持JBOD，则要求将每个硬盘做成一个RAID逻辑盘，同时建议关闭RAID卡的写缓存。此时不支持硬盘热插拔。
  （3）关于硬盘
   a.主机需要1个独立的系统盘，60G以上（在虚拟存储之外）。
   b.SSD缓存盘中HDD数据盘的数量建议为1:4，都要求企业级硬盘。
  （4）关于网口
   a.VMP/aSV都建议将集群管理口、存储通信口和业务网口分隔，因此网口数量建议3个以上。
   b.网口工作速率都要求千兆或万兆。
  （5）参考配置
    CPU：Inter（R）Xeon（R）CPU E5-2650*2或以上
    内存：96G或以上
    RAID：LSI-9240-8i（配置为JBOD）
    网卡：千兆以太网卡*4或以上
    硬盘：系统盘128G SSD或以上
          缓存盘Inter DC S3500容量240G*2或以上
          数据盘容量2T以上7200转SATA企业级硬盘*4个以上
    电源：双路冗余电源
    存储私网交换机：背板带宽48Gbps以上品牌千兆交换机，网口数按实际情况。


三、业务系统迁移跟虚拟机导入导出
1、P2V/V2V系统迁移
  （1）迁移介绍
   迁移物理主机，可以将现有物理主机或VMware或Citrix平台上的Windows/Linux操作系统通过网络克隆到Sangfor HCI平台上。迁移过程中需要重启原操作系统，迁移完成后原操作系统即可在HCI平台上继续运行。对原操作系统不做任何修改，其可以关机，也可以开机同时使用（需避免地址冲突）。
  （2）物理主机迁移
   a.Windows系统物理主机迁移
   b.Linux系统物理主机迁移
  （3）迁移条件
   CPU要求为64位CPU；内存要求大于等于2GB；硬盘不支持动态格式的硬盘，其余均支持；网卡要求至少有一张网卡；支持系统，Windows XP/7/2003/2008/2012 32位及64位系统、内核版本高于2.6.18以上的Linux。
  （4）Windows系统迁移
   a.上传迁移工具到待迁移的Windows系统，打开工具
   b.选择迁移当前主机
   c.选择迁移的目的HCI主机
   d.配置迁移后的目的虚拟机参数
  （5Linux系统迁移过程
   a.Linux插入制作的HCI安装U盘
   b.从U盘启动，启动界面选择迁移物理主机（P2V），迁移前需要进行网络配置。先给当前物理主机配置一个IP用于跟目标HCI主机通信传输迁移数据，注意Linux服务器跟HCI之间不能经过NAT环境。再配置好目标HCI主机IP，登录HCI主机控制台，点击【迁移物理主机】，查看待迁移任务并配置虚拟机名称、存储位置、运行位置等基本信息，以及虚拟机的硬件配置信息。

2、虚拟机导入导出
  （1）OVA文件导出
   a.从VMware VSphere Client导出ova文件。
   b.Citrix Xenserver 导出ova文件。
  （2）HCI导入ova文件步骤
   a.创建新虚拟机，选择导入虚拟机方式。
   b.选择ova文件，配置新建虚拟机的所属分组，存储位置和运行位置等信息。
   c.导入成功后点击转到虚拟机即可进入虚拟机详情页面。
  （3）HCI导入ova文件步骤
   a.创建新虚拟机，选择导入虚拟机方式
   b.选择ova文件，配置新建虚拟机的所属分组，存储位置和运行位置等信息
   c.导入成功后点击转到虚拟机即可进入虚拟机详情页面

四、HCI高级功能
1、用户权限
  （1）深信服超整合研发云场景
   a.资源：用户可以操作的对象，包括虚拟机、虚拟网络设备、存储、物理磁盘等。
   b.权限：用户可以对对象的操作集合，包括虚拟机操作权限，虚拟网络配置权限等。
   c.系统权限：用户可以对超融合平台进行统一的管理，包括物理资源管理、系统配置与维护、业务维护。
   d.资源配额：指定用户最多创建多少资源，包括（CPU、内存、磁盘大小），避免单一用户占用过多的资源。
2、Oracle安装
  （1）Oracle数据库系统是目前世界上流行的关系数据库管理系统，系统可移植性好、使用方便、功能强，适用于各类大、中、小、微机环境。它是一种高效率、可靠性好的适应高吞吐量的数据库解决方案。但是Oracle数据库的安装和部署都比较复杂，需要非常专业的认识才可以安装，为此我们从HCI5.2开始版本做了Oracle的向导式安装，同时VS也做了相应的功能，将虚拟共享盘作为Oracle Rac的外置存储，解决了需要昂贵的外置FC和iSCSI存储。
  （2）虚拟共享盘
   共享盘目前也是用iSCSI代理的方式实现，因此本质是一样的。最大的区别是iSCSI磁盘走管理网通信，共享盘走存储网通信，而且共享盘只能供集群内虚拟机使用，外部iSCSI客户端扫描不到。

3、虚拟机大页内存
  （1）为什么要采用大页内存？
   在Linux操作系统上运行内存需求量较大的应用程序时，由于其采用的默认页面大小为4KB，因而将会产生较多TLB Miss和缺页中断，从而大大影响应用程序的性能。当操作系统以2MB甚至更大作为分布的单位时，将会大大减少TLB Miss和缺页中断的数量，显著提高应用程序的性能。这也正是Linux内核引入大页面支持的直接原因。
  （2）实现原理
   开始--全局大页开关是否开启--虚机是否勾选大页--检查主机大页数量是否正确，如果有误，则设置为正确的值--检查主机内存是否足够分配大页--尝试分配大页--采用大页方式启动虚机--结束。
  （3）配置方法
   在HCI中让虚拟机使用HugePages很简单，新建或者编辑虚拟机，勾选“使用大页内存”。
  （4）注意事项
   使用HugePages的内存页是不会被交换出去到磁盘的，永远常驻在内存中，HugePages的内存不能被其他的进程使用。

4、虚拟机Numa
  （1）Numa简介
   a.需要理解几个概念。一台服务器一般有多个物理CPU（也叫作Socket或者节点，下文用“节点”统称），每一个物理CPU有多个核，每一个核在超线程下可以模拟两个逻辑CPU。例如我的一台服务器有4个节点，32个核（每一个节点8核），64个逻辑CPU。
   b.目前主流的服务器很多都是numa架构的，对于这种架构的物理CPU（节点），和自己直接连接的内存称为本地内存，而连接在其他物理CPU（节点）的内存称为远地内存。物理CPU访问远地内存时候要通过QPI（Quick Path Interconnect，快速通道互联）间接访问，所以相对访问本地内存而言存在一定的延时。同理每一个CPU（节点）都有自己的PCIE设备（本地IO资源），和内存相似，远地访问PCIE设备相对访问本地PCIE设备存在延时。
  （2）虚拟机Numa的应用
   a.内存访问旺盛的业务
    Numa能帮助大幅度提高性能！如需要大量吃内存的数据库服务（Oracle、SQL Server）、编译服务等。内存访问频繁的场景，开启Numa，计算性能提高7%-30%。
   b.CPU需求密集的小应用
    开启Numa会影响一些性能，由于我们超融合一体机原来的CPU性能充足，开启Numa造成的损失并不足影响到业务，所以在部分应用无须考虑该问题。
  （3）虚拟机Numa配置
   a.全局
   管理--高可用（HA）与资源调度配置--系统参数，勾选“开启Numa调度”。
   b.虚拟机层面
   编辑虚拟机--硬件--处理器，勾选“启用Numa调度”。

5、一键检测
  （1）模块功能
   我们分析发现34%的技术支持问题都是由于硬件、配置、系统问题导致，这些问题都会直接导致主机宕机、虚拟机启动不了、虚拟机性能慢等严重问题。
   而传统运维工具是从外部进行探测，当出现问题时，很难判断是硬件问题？还是平台问题？还是环境问题？运维人员排错耗费大量时间，中断业务时间长！
   超整合一键检测从系统内部进行检测，找到硬件及平台具体问题提供解决方案，确保平台层面没有问题，实现0基础超融合平台运维。
  （2）价值
   a.简化运维，快速排障
   一键检测系统硬件、配置、系统健康状态。
   通过一键检测，快速定位问题位置（硬件、平台、业务），进行分层检查，提供故障详细解决方案。
   b.提升业务稳定性
   提供最优配置检测，确保虚拟化平台高可靠、高性能、高稳定。