VMP?
虚拟化管理平台（Virtualization Management Platform）  
为云桌面提供了可靠的运行平台和完善的管理功能，拥有虚拟机快速部署、资源管理及监控、集群高可用、动态迁移、数据备份及恢复等功能

VMP作用
1.充分利用主机的硬件资源，为虚拟机提供运行环境，对虚拟机使用的资源进行分配和调度。
2.提供虚拟机管理平台和操作接口。
+++++++++++
VMP安装
一、准备材料
可以选择使用客户现有服务器安装VMP，或者使用预装VMP的深信服桌面云一体机VDS设备。
如使用一体机VDS设备，设备已事先预装VMP，无需手动安装。
如使用客户现有服务器即第三方服务器安装VMP，需准备以下材料
1.主机（服务器硬件）
2.VMP系统镜像（ISO文件）
3.U盘/刻录光盘
4.普通电脑（用于配置）

1.主机要求
CPU：必须支持Intel  Virtualization Technology (VT-x)
(VT-x是intel运用Virtualization虚拟化技术中的一个指令集。保护性：英特尔VT-x 具备的虚拟机迁移特性还可为您的 IT 投资提供有力保护，并进一步提高故障切换、负载均衡、灾难恢复和维护的灵活性。)
内存：至少4GB以上内存（实安只3.5，但运VDC,至少8G）
磁盘：至少60GB以上磁盘容量
其他：至少1张千兆有线网卡
（注意：对于内存，实际安装只需要3.5G。但由于还需要运行VDC、虚拟机建议至少8G内存）
2.服务器配置
关闭节能模式
同步BIOS时间
启用Intel VT-x技术(关闭了VT-x，会导致虚拟机无法开机)
启用加电自动开机
配置RAID阵列

2.1关闭节能模式（在BIOS修改）
现代的CPU为了在空闲的时候节约能源，可以接受命令进入Low Power模式，统称为C-States或者C-Modes。他们通过降低CPU主频或电压来实现节约能源。
在虚拟化运行过程中，节能模式无法响应虚拟机突发的资源请求，会造成虚拟机无法及时获得CPU资源，产生虚拟机运行卡顿的问题。所以安装VMP之前，请务必从BIOS中关闭所有节能选项。
注意：VMP安装前要求在服务器BIOS设置中关闭节能模式。如果开启了节能模式，会导致无法充分利用资源、虚拟机运行会非常卡。
2.2同步BIOS时间
为了保证VMP正常运行，安装前需要校准BIOS时间。
启用Intel VT-x技术
2.3Intel VT-x虚拟化技术是安装VMP的必要条件之一，如果未启用VT-x则无法安装VMP。安装VMP成功后如果关闭了VT-x，会导致虚拟机无法开机
2.4启用加电自动开机
如果出现停电等故障，启用加电自动开机，可以确保主机加电后自动启动以恢复VMP运行。
2.5配置RAID阵列
主机如有RAID卡，需配置RAID阵列，可以参照RAID厂商的说明文档。建议配置为RAID10

第2和3点:刻录VMP系统镜像到U盘
所需材料:1.VMP镜像文件  2.刻录工具UltraISO
从U盘引导服务器安装VMP，修改启动项从U盘启动，即可进入VMP安装过程
+++++++++++++++
VMP使用?
1.控制台登录
(浏览器):VMP控制台页面基于HTML5技术(h5)实现，要求使用Chrome、Firefox或者IE11等浏览器进行管理。推荐使用Chrome浏览器。不用360浏览器
（chrome,firefox,ie11,不用360）

2.控制台界面介绍（web界面）
2.1版本
从VMP4.6开始，在控制台主界面可以看到VMP的版本信息
2.2导航栏
首页：用于VMP的主机、虚拟机、存储相关配置和管理及状态查看。
虚拟机：用于VMP虚拟机的相关配置和管理。
虚拟网络：用于VMP虚拟网络相关配置管理。
实体机：用于VMP的集群、实体主机和存储相关配置和管理。
管理：可配置序列号、日期与时间、用户、告警设置、用户体验计划、日志与告警、虚拟机备份与恢复、系统配置备份与恢复、设备升级、VMP平台访问参数。
叹号显示当前告警数，点击告警数展开最近5条告警日志。
2.3快捷操作按钮
创建虚拟机、备份虚拟机、恢复虚拟机、迁移物理主机、添加物理主机、添加存储。
2.4集群资源显示
包括CPU、内存、磁盘以及主机数，虚拟机数
2.5实体机状态(正蓝，离灰，掉红)
主机离线：灰色显示
存储离线和主机告警：红色显示
正常状态：蓝色显示。

(重要)
虚拟机：该界面可进行创建虚拟机、编辑虚拟机、克隆、快照、备份、恢复等操作。
虚拟网络：该界面可进行创建虚拟交换机、编辑虚拟交换机等操作。
虚拟存储：该界面可看到虚拟存储内磁盘状态，进行管理存储空间等操作。
实体机：该界面显示当前集群中的所有主机信息，包括主机状态、名称、IP地址、CPU使用率、内存大小、内存占用率和运行时长等信息，可进行添加主机、管理主机的存储空间等操作。
管理：该界面可对序列号、日期与时间、用户、告警设置、用户体验计划、日志与告警、虚拟机备份与恢复、系统配置备份与恢复、设备升级、VMP平台访问参数等进行查看与操作。
+++++++++
组建集群
集群
1.将安装了VMP软件的物理主机统一加入到同一个管理平台进行维护。
2.方便业务部署，也可以提高资源的有效利用率。
3.一般和外置存储或虚拟存储配合使用。
4.一台VMP主机只能加入一个集群，加入后除网络配置外，其余配置均会从集群控制器上同步。
步骤一 （准备）
1.将需要组建集群的主机配置好ip，主机间用光纤线连一起（是在网卡端口左边的小口）。
2.将全部主机接到同一个二层交换机上（全部主机的网卡端口都连在同一台交换机上）。
3.选择一台VMP主机作为“集群控制器”(主控主机)，登录控制台并添加其他主机

虚拟存储
1.存储通信网口配置(单交换机链路聚合)-设置eth8,9虚拟网口作为虚拟存储
2.初始化虚拟存储-2副本（同一数据保2份，初始化后无法修改副本数量），打勾“SSD作为缓存盘”
3.网络连通性探测IP不是一定要配置，但是建议配置，通常配置为VMP管理口的网关：
当VMP主机间通信异常时,可能出现集群分裂（集群中主机以为主控离线就都把自己当成主控）的情况。此时同一个虚拟机可能在不同主机上同时运行,会出现数据不一致的情况。
为了避免这种情况发生,需要配置一个探测IP。主机会通过PING去探测该IP的连通性,无法PING通时则认为自己脱离集群,成为孤立状态。此时该孤立主机上的虚拟机保持沉默,不再提供服务,主机恢复后会从其他主机的副本上同步数据

二、集群ip（防止集群那台“集群控制器“故障还能用集群IP连上集群管理）
通常情况可以直接通过平台中的任一主机IP来管理此集群。但如果该主机故障或连接该主机失败后，将无法继续管理集群。
使用集群IP后，可以避免主机故障而导致无法正常管理集群的情况。通过集群IP连接到此集群时，可以更加稳定的管理虚拟机
VMP集群默认使用组播通信,组播地址不固定

三、修改主机IP
实体机-物理主机（点主机IP）-网络名称（对应网口名称一行的小笔图标编辑）-编辑网口

#注意
两个主机集群，当172.16.127.174为主控时，上172.16.127.175(非主控)登录页面会显示进入不了控制界面，显示主控离线，还切换当前为主控
（这个原因是因为集群的ip和局域网不在同一网段）


+++++++++++
虚拟机操作
一、新建虚拟机
创建全新虚拟机
1.上传iso镜像
只支持使用Windows XP、Windows 7 X86/X64、Windows10 X86/X64，推荐使用Windows 7 Ultimate SP1
2.新增虚拟机   3.安装操作系统

1.上传iso镜像
（虚拟存储-配置-管理存储空间-上传文件-上传本地镜像到存储）
（只能上传iso或者qcow2（写时复制）格式的文件）
1.1从web控制台界面上传
1.2开启文件共享，从文件共享上传
1.3直接读取网络文件共享中的ISO文件
1.4注意：必须使用原版镜像，不能用Ghost或修改版镜像
从web控制台界面上传（上传到虚拟存储）
从web控制台界面上传（上传到本地存储）

创建全新虚拟机
虚拟机-新增-创建全新虚拟机
1.虚拟机命名：1.名称唯一性 2.名称可包括中文、数字、字母以及部分符号
2.操作系统选择：建议与虚拟机需要安装的操作系统类型一致
3.硬件快速配置
    3.1低配(虚拟机建议最低配置)
     CPU 1核/内存 2GB/磁盘 40GB
    3.2标配(标准配置)
     CPU 2核/内存 4GB/磁盘 80GB
    高配(较高配置)
     CPU 2核/内存 8GB/磁盘 80GB

VMP5.35版本
1 2 40
2 2 80
4 8 80

4.磁盘
4.1磁盘文件：虚拟机的每个磁盘是以单个文件的形式存放在VMP的存储上，文件后缀为qcow2
4.2分配方式
   4.2.1预分配：按配置的大小来分配磁盘并初始化空间，文件初始体积最大，但可以避免文件碎片化，磁盘IO效率最高。
    4.2.2精简分配：不分配磁盘，也不初始化，写入数据时才分配并初始化，磁盘IO效率最低。适用于磁盘空间不充裕的场景。（使用精简分配，当分配的空间超过实际磁盘容量时，会导致无法写入数据，所以尽量免超配)
    4.2.3已有磁盘，已经存在的磁盘文件。

5.光驱
1.虚拟光驱，用于加载ISO镜像文件
2.ISO文件 ：2.1从存储中加载：需提前上传至VMP存储空间  2.2从共享路径中加载：需添加文件共享服务器
(注意：这一步安装时，选择光驱，在光驱里选择上传好的镜像，才能正常安装新虚拟机的系统；也可以点虚拟机-更多 -编辑-硬件-光驱-选择此前上传好的ISO镜像)

新增网卡
1.虚拟机的网卡只能通过虚拟交换机才能连接使用主机的物理网卡，与外界进行通信
2.虚拟机网卡类型：
   Realtek RTL8139
   Intel E1000

#（注意）安装必要的组件如agent
下载安装window版的agent组件（必须安装，否则容易出现很多问题）
Agent的作用
1、虚拟机派生完成后,首次开机时需要Agent接入VDC执行初始化过程
2、Agent程序会自动将原存放于Windows系统盘的“我的文档”等个人文件夹重定向到个人磁盘
3、如果启用网页浏览加速,当桌面虚拟机分配内存大于2.5GB时,Agent程序可以划分一部分内存空间作为磁盘缓存,用作IE等浏览器的缓存目录,以提升网页浏览的加载速度
4、安装Agent程序的同时,虚拟机会安装性能优化工具,优化虚拟机的各项性能
5、确保虚拟机U盘,鼠标键盘,磁盘等使用稳定
6、避免出现其他使用异常的现象
###注意：（WINDOS安装agent时会自动安装性能优化工具，而linux安装性能优化工具时，要根据光驱挂载到文件夹再给777权限安装）

#（虚拟机转模板前）关闭系统防火墙，系统更新并确认ip地址是自动获取（手误绑定之后不记得的情况发生），因为等下会进行转换模板，模板虚拟机不能绑定地址，否则会造成ip冲突

（重点）虚拟机克隆与派生
克隆
1.创建虚拟机（父本）的完整副本到任意位置
2.副本完全独立，与父本无任何关联
派生（模板部署）
1.由虚拟机（模板）创建新的虚拟机
2.增量创建，新的虚拟机继承模板的属性和内容
3.模板修改后可以更新到派生虚拟机
（注意：直接从VMP上派生虚拟机是不能关联给用户使用，这里只是介绍VMP本身也有派生虚拟机的功能，若要关联给用户使用请在VDC上派生）


#模板虚拟机就是一台安装配置完成的虚拟机，用于生成多台完全相同的虚拟机，派生资源
注意事项：（1磁才转模板，模板才派生，模后不可改磁（但派生可增改），派生机克隆后才能转模板）
1、超过一块磁盘的虚拟机无法转换成模板
2、部署为模板的虚拟机才能进行派生虚拟机操作
3、部署为模板后，不可编辑磁盘相关配置
4、由模板派生虚拟机，派生出的虚拟机跟模板虚拟机配置一样
5、派生出来的虚拟机不可以直接转换成模板，但可以通过克隆该虚拟机，然后将克隆后的虚拟机转换成模板

+++++++++++++
虚拟机快照与恢复
快照
1.保存虚拟机当前状态到当前存储位置
2.增量保存，速度快
3.用于虚拟机故障恢复
回滚
1.回到快照前的状态，丢失快照后所有修改

虚拟机备份与恢复
备份（异地快照）
1虚拟机当前状态到其他存储（完整保存）
2优势：无共享存储时异地备份
（要求：备份的源和目的不在同一存储上）
恢复
1.当前主机故障后，将其他存储上已备份的虚拟机恢复到集群任意位置
（注意：恢复到非原始位置时会删除原虚拟机）
操作步骤同快照与恢复，只是目标位置选为其他存储

虚拟交换机
概念
1.用于将虚拟机通过一定的方式使用VMP主机的物理网口连接到网络中。
2.同一个虚拟交换机可以使用VMP集群中各台主机的不同位置的物理网口。
桥接
1.使用虚拟交换机将虚拟机与物理网口进行连接的方式。

连接方式
1.不连接到物理网络
  1.1用于虚拟机到虚拟机之间的连接
  1.2不连接到物理网口，不连接外部物理网络
2.连接到物理网络
3.连接到物理网络+VLAN

桥接到物理网络
虚拟交换机直接连接到物理网口。
虚拟机通过连接虚拟交换机，直接使用VMP的物理网口跟物理网络进行通信。（虚拟机网络数据通过虚拟交换机透传到物理网口）


